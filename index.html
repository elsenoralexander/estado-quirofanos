<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Quirófanos - Quirónsalud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; background-color: #f8fafc; color: #1e293b; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .logo-overlap { filter: drop-shadow(0 10px 15px rgba(0,0,0,0.15)); transform: translateY(20%); z-index: 50; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDUtotD90gGjoCpFGOlJ7-N8SJfu9SHpuM",
            authDomain: "quirofanos-bf581.firebaseapp.com",
            projectId: "quirofanos-bf581",
            storageBucket: "quirofanos-bf581.firebasestorage.app",
            messagingSenderId: "418576214169",
            appId: "1:418576214169:web:6f9e6ea05149ed17717008",
            measurementId: "G-XT3305XCX7"
        };
        const currentAppId = 'quirofanos-bf581';
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. DATOS MAESTROS ---
        const EQUIPOS_NOMBRES = ["Iluminación quirúrgica", "Carro Anestesia", "Monitor Anestesia", "Monitor auxiliar", "Electrobisturí", "Tecnología SpO2", "Instalación Imagen", "Mesa quirúrgica", "Auxiliares Cirugía", "Pc Casiopea (Pared)"];
        const PRIORIDAD_ESTRATEGICA = { "Electrobisturí": 1, "Iluminación quirúrgica": 2, "Mesa quirúrgica": 3, "Carro Anestesia": 4, "Auxiliares Cirugía": 5 };

        // --- 3. FUNCIONES GLOBALES DE UTILIDAD ---
        const getStatusColor = (st) => {
            switch(st?.toLowerCase()) {
                case 'operativo': return 'bg-emerald-500';
                case 'mantenimiento': return 'bg-amber-500';
                case 'no disponible': return 'bg-red-500';
                default: return 'bg-slate-400';
            }
        };

        const calcularAntiguedad = (fecha) => {
            if (!fecha) return 0;
            const edad = Math.floor((Date.now() - new Date(fecha).getTime()) / (1000 * 60 * 60 * 24 * 365.25));
            return Math.max(0, edad);
        };

        const getAgeColors = (anios) => {
            if (anios < 10) return { border: 'border-l-emerald-500', text: 'text-emerald-600', bg: 'bg-emerald-50', fullBorder: 'border-emerald-500' };
            if (anios <= 15) return { border: 'border-l-amber-500', text: 'text-amber-600', bg: 'bg-amber-50', fullBorder: 'border-amber-500' };
            return { border: 'border-l-red-500', text: 'text-red-600', bg: 'bg-red-50', fullBorder: 'border-red-500' };
        };

        const isMaintenanceOverdue = (fecha, period) => {
            if (!fecha) return false;
            const f = new Date(fecha);
            if (period === 'semestral') f.setMonth(f.getMonth() + 6);
            else if (period === 'anual') f.setFullYear(f.getFullYear() + 1);
            else if (period === 'bienal') f.setFullYear(f.getFullYear() + 2);
            return f.getTime() < Date.now();
        };

        const calcularProximaRevision = (fecha, period) => {
            if (!fecha) return "Pendiente";
            const f = new Date(fecha);
            if (period === 'semestral') f.setMonth(f.getMonth() + 6);
            else if (period === 'anual') f.setFullYear(f.getFullYear() + 1);
            else if (period === 'bienal') f.setFullYear(f.getFullYear() + 2);
            return f.toLocaleDateString('es-ES');
        };

        // --- 4. COMPONENTE DE ICONOS ---
        const Icon = ({ name, className = "w-6 h-6", size = 24, strokeWidth = 2 }) => {
            const icons = {
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                Camera: <React.Fragment><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></React.Fragment>,
                Wifi: <React.Fragment><path d="M5 13a10 10 0 0 1 14 0"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><circle cx="12" cy="20" r="1"/></React.Fragment>,
                Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>,
                Stethoscope: <React.Fragment><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6h2a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></React.Fragment>,
                Edit: <React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></React.Fragment>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                X: <React.Fragment><path d="M18 6 6 18"/><path d="M6 6l12 12"/></React.Fragment>,
                ExternalLink: <React.Fragment><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></React.Fragment>,
                FileText: <React.Fragment><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></React.Fragment>,
                BarChart: <React.Fragment><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></React.Fragment>,
                LayoutGrid: <React.Fragment><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></React.Fragment>,
                Layers: <React.Fragment><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></React.Fragment>,
                History: <React.Fragment><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></React.Fragment>,
                AlertCircle: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></React.Fragment>,
                Truck: <React.Fragment><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></React.Fragment>,
                EyeOff: <React.Fragment><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></React.Fragment>,
                RefreshCw: <React.Fragment><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></React.Fragment>,
                Info: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></React.Fragment>,
                Calendar: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></React.Fragment>,
                Link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" style={{ width: size, height: size }} className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- 5. COMPONENTE DASHBOARD ---
        const Dashboard = ({ equipments, rooms }) => {
            const chartRef1 = useRef(null);
            const chartRef2 = useRef(null);

            const stats = useMemo(() => {
                const active = equipments.filter(e => e.existe !== false);
                const aniosArr = active.map(e => ({ age: calcularAntiguedad(e.fechaAdquisicion), e }));
                const okCount = aniosArr.filter(a => a.age < 10).length;
                const vetCount = aniosArr.filter(a => a.age >= 10 && a.age <= 15).length;
                const obsCount = aniosArr.filter(a => a.age > 15).length;
                const total = active.length || 1;
                const okPct = ((okCount/total)*100).toFixed(1);
                const vetPct = ((vetCount/total)*100).toFixed(1);
                const obsPct = ((obsCount/total)*100).toFixed(1);
                const maintEq = active.filter(e => e.requierePreventivo !== false);
                const maintOk = maintEq.filter(e => !isMaintenanceOverdue(e.ultimaRevision, e.periodicidad)).length;
                return { total: active.length, okCount, vetCount, obsCount, okPct, vetPct, obsPct, maintTotal: maintEq.length, maintOk };
            }, [equipments]);

            useEffect(() => {
                const c1 = new Chart(chartRef1.current.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: [`OK (${stats.okPct}%)`, `Veterano (${stats.vetPct}%)`, `Obsoleto (${stats.obsPct}%)`],
                        datasets: [{ data: [stats.okCount, stats.vetCount, stats.obsCount], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }]
                    },
                    options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom' } } }
                });

                const famData = EQUIPOS_NOMBRES.map(n => ({
                    n, count: equipments.filter(e => e.nombre === n && e.existe !== false && calcularAntiguedad(e.fechaAdquisicion) > 15).length
                })).sort((a, b) => b.count - a.count);

                const c2 = new Chart(chartRef2.current.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: famData.map(d => d.n),
                        datasets: [{ label: 'Obsoletos', data: famData.map(d => d.count), backgroundColor: famData.map(d => d.count > 0 ? '#ef4444' : '#e2e8f0'), borderRadius: 6 }]
                    },
                    options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return () => { c1.destroy(); c2.destroy(); };
            }, [stats, equipments]);

            const plan = useMemo(() => equipments.filter(e => e.existe !== false && calcularAntiguedad(e.fechaAdquisicion) >= 14).sort((a,b) => {
                const pA = PRIORIDAD_ESTRATEGICA[a.nombre] || 99, pB = PRIORIDAD_ESTRATEGICA[b.nombre] || 99;
                return pA !== pB ? pA - pB : calcularAntiguedad(b.fechaAdquisicion) - calcularAntiguedad(a.fechaAdquisicion);
            }), [equipments]);

            return (
                <div className="space-y-8 animate-in text-left">
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-left">
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100"><p className="text-[10px] font-black text-slate-400 uppercase mb-1">Activos Operativos</p><h3 className="text-4xl font-black text-slate-800 text-left">{stats.total}</h3></div>
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 border-l-4 border-l-red-500"><p className="text-[10px] font-black text-slate-400 uppercase mb-1">Índice Obsolescencia</p><h3 className="text-4xl font-black text-red-500 text-left">{stats.obsPct}%</h3></div>
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 border-l-4 border-l-emerald-500"><p className="text-[10px] font-black text-slate-400 uppercase mb-1">Preventivos OK</p><h3 className="text-4xl font-black text-emerald-500 text-left">{((stats.maintOk/stats.maintTotal)*100 || 0).toFixed(1)}%</h3></div>
                        <div className="bg-[#00A896] p-6 rounded-3xl shadow-lg text-white"><p className="text-white/70 text-[10px] font-black uppercase mb-1">Quirófanos Listos</p><h3 className="text-4xl font-black text-left">{rooms.filter(r => r.estado === 'Operativo').length} / {rooms.length}</h3></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 text-left">
                        <div className="bg-white p-8 rounded-[2.5rem] shadow-sm h-[400px] flex flex-col text-left"><h4 className="font-black text-slate-800 uppercase text-sm mb-6 flex items-center gap-2"><Icon name="Activity" size={16} className="text-[#00A896]"/> Salud del Parque Quirúrgico</h4><div className="flex-grow"><canvas ref={chartRef1}></canvas></div></div>
                        <div className="bg-white p-8 rounded-[2.5rem] shadow-sm h-[400px] flex flex-col text-left"><h4 className="font-black text-slate-800 uppercase text-sm mb-6 flex items-center gap-2"><Icon name="BarChart" size={16} className="text-[#00A896]"/> Ranking Familias Críticas</h4><div className="flex-grow"><canvas ref={chartRef2}></canvas></div></div>
                    </div>
                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 text-left overflow-hidden">
                        <h4 className="font-black text-slate-800 uppercase text-lg flex items-center gap-2 mb-6"><Icon name="AlertCircle" size={20} className="text-red-500"/> Plan de Renovación Priorizado</h4>
                        <div className="overflow-x-auto"><table className="w-full text-left">
                            <thead><tr className="text-[10px] font-black text-slate-400 border-b uppercase"><th className="pb-3 px-2">Activo Prioritario</th><th className="pb-3 px-2">Ubicación</th><th className="pb-3 px-2">Antigüedad</th><th className="pb-3 px-2 text-right">Estrategia</th></tr></thead>
                            <tbody>
                                {plan.map(e => (
                                    <tr key={e.id} className="border-b last:border-0 hover:bg-slate-50 transition-colors">
                                        <td className="py-4 px-2 text-left min-w-[150px]"><p className="font-bold text-slate-800">{e.nombre}</p><p className="text-[10px] text-slate-400 italic">"{e.descripcion}"</p></td>
                                        <td className="py-4 px-2 text-left text-[#00A896] font-black uppercase text-xs">{rooms.find(r => r.id.toString() === e.roomId.toString())?.nombre}</td>
                                        <td className="py-4 px-2 text-left font-black text-lg">{calcularAntiguedad(e.fechaAdquisicion)} años</td>
                                        <td className="py-4 px-2 text-right min-w-[140px]"><span className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase text-white ${calcularAntiguedad(e.fechaAdquisicion) > 15 ? 'bg-red-500 animate-pulse' : 'bg-amber-500'}`}>{calcularAntiguedad(e.fechaAdquisicion) > 15 ? 'Renovación Inmediata' : 'Planificar Cambio'}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table></div>
                    </div>
                </div>
            );
        };

        // --- 6. COMPONENTE APP PRINCIPAL ---
        function App() {
            const [mainTab, setMainTab] = useState('rooms'); 
            const [view, setView] = useState('landing');
            const [rooms, setRooms] = useState([]);
            const [equipments, setEquipments] = useState([]);
            const [connections, setConnections] = useState([]);
            const [config, setConfig] = useState({ logo: "" });
            const [familyImages, setFamilyImages] = useState({});
            const [selectedORId, setSelectedORId] = useState(null);
            const [selectedEqId, setSelectedEqId] = useState(null);
            const [selectedFamily, setSelectedFamily] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncing, setSyncing] = useState(false);

            const [isEditingDesc, setIsEditingDesc] = useState(false);
            const [isEditingMaint, setIsEditingMaint] = useState(false);
            const [isEditingAge, setIsEditingAge] = useState(false);
            const [isTransferring, setIsTransferring] = useState(false);
            const [transferMsg, setTransferMsg] = useState('');
            const [manualLink, setManualLink] = useState('');

            const logoFileRef = useRef();
            const eqFileRef = useRef();
            const fileRef = useRef();
            const manualFileRef = useRef();
            const familyFileRef = useRef();

            const getColl = (name) => db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection(name);

            useEffect(() => {
                auth.signInAnonymously().then(() => {
                    getColl('rooms').onSnapshot(s => { if(!s.empty) setRooms(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => parseInt(a.id) - parseInt(b.id))); setLoading(false); });
                    getColl('equipments').onSnapshot(s => { if(!s.empty) setEquipments(s.docs.map(d => ({id: d.id, ...d.data()}))); });
                    getColl('connections').onSnapshot(s => { if(!s.empty) setConnections(s.docs.map(d => ({id: d.id, ...d.data()}))); });
                    getColl('settings').doc('global').onSnapshot(d => { if(d.exists) setConfig(d.data()); });
                    getColl('settings').doc('families').onSnapshot(d => { if(d.exists) setFamilyImages(d.data()); });
                });
            }, []);

            const saveChange = async (coll, docId, data) => {
                setSyncing(true);
                await getColl(coll).doc(docId).set(data, {merge: true});
                setTimeout(() => setSyncing(false), 800);
            };

            const handleMaintDoneToday = (id) => {
                saveChange('equipments', id, { ultimaRevision: new Date().toISOString().split('T')[0] });
                setIsEditingMaint(false);
            };

            const handleTransfer = async (movingEq, targetRoomId) => {
                const targetEq = equipments.find(e => 
                    e.roomId.toString() === targetRoomId.toString() && 
                    e.nombre === movingEq.nombre && 
                    e.id !== movingEq.id &&
                    e.existe !== false
                );

                if (targetEq) {
                    setTransferMsg(`Intercambiando con equipo de ${rooms.find(r => r.id == targetRoomId)?.nombre}...`);
                    await saveChange('equipments', movingEq.id, { roomId: targetRoomId });
                    await saveChange('equipments', targetEq.id, { roomId: movingEq.roomId });
                    setTransferMsg('Intercambio realizado con éxito');
                } else {
                    setTransferMsg(`Moviendo a ${rooms.find(r => r.id == targetRoomId)?.nombre}...`);
                    await saveChange('equipments', movingEq.id, { roomId: targetRoomId });
                    setTransferMsg('Traslado realizado con éxito');
                }

                setTimeout(() => { setTransferMsg(''); setIsTransferring(false); }, 2500);
            };

            const handleUpload = (e, type, id) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    if (type === 'manual') saveChange('equipments', id, { manualUrl: event.target.result, manualExternalUrl: "" });
                    else {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > 800) { h *= 800 / w; w = 800; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            const comp = canvas.toDataURL('image/jpeg', 0.6);
                            if (type === 'room') saveChange('rooms', id.toString(), { imagen: comp });
                            else if (type === 'eq') saveChange('equipments', id, { imagen: comp });
                            else if (type === 'family') saveChange('settings', 'families', { [id]: comp });
                        };
                    }
                };
                reader.readAsDataURL(file);
            };

            const selectedOR = rooms.find(r => r.id == selectedORId);
            const selectedEq = equipments.find(e => e.id == selectedEqId);

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-white"><div className="w-12 h-12 border-4 border-[#00A896] border-t-transparent rounded-full animate-spin"></div><p className="mt-4 font-black uppercase text-xs tracking-widest text-[#00A896]">Sincronizando Centro Técnico...</p></div>
            );

            // --- VISTAS ---
            if (view === 'landing') return (
                <div className="min-h-screen pb-20 animate-in text-left">
                    <header className="bg-[#00A896] min-h-[5rem] py-4 sm:py-0 shadow-md text-white sticky top-0 z-30 flex flex-col sm:flex-row items-center justify-between px-4 sm:px-6 gap-4">
                        <div className="flex items-center gap-3 sm:gap-4 w-full sm:w-auto">
                            <div className="w-16 h-16 sm:w-20 sm:h-20 bg-white rounded-3xl flex items-center justify-center logo-overlap border-4 border-slate-50 shadow-2xl shrink-0">
                                {config.logo ? <img src={config.logo} className="w-full h-full object-contain p-1" /> : <Icon name="Stethoscope" size={28} className="text-[#00A896]" />}
                            </div>
                            <h1 className="text-lg sm:text-xl font-black uppercase tracking-tight">GESTIÓN QUIRÓFANOS</h1>
                            {syncing && <div className="sm:hidden ml-auto"><Icon name="RefreshCw" size={14} className="animate-spin text-white"/></div>}
                        </div>
                        
                        <div className="flex bg-white/20 p-1 rounded-2xl w-full sm:w-auto overflow-x-auto no-scrollbar scroll-smooth">
                            <div className="flex flex-nowrap min-w-full sm:min-w-0">
                                <button onClick={() => setMainTab('rooms')} className={`flex-1 sm:flex-none px-4 py-2 rounded-xl text-[10px] sm:text-xs font-bold transition-all whitespace-nowrap ${mainTab === 'rooms' ? 'bg-white text-[#00A896]' : 'text-white'}`}>QUIRÓFANOS</button>
                                <button onClick={() => setMainTab('families')} className={`flex-1 sm:flex-none px-4 py-2 rounded-xl text-[10px] sm:text-xs font-bold transition-all whitespace-nowrap ${mainTab === 'families' ? 'bg-white text-[#00A896]' : 'text-white'}`}>FAMILIAS</button>
                                <button onClick={() => setMainTab('data')} className={`flex-1 sm:flex-none px-4 py-2 rounded-xl text-[10px] sm:text-xs font-bold transition-all whitespace-nowrap ${mainTab === 'data' ? 'bg-white text-[#00A896]' : 'text-white'}`}>DATOS</button>
                            </div>
                        </div>
                        
                        {syncing && <div className="hidden sm:flex items-center gap-2"><Icon name="RefreshCw" size={12} className="animate-spin text-white"/><span className="text-[10px] font-bold uppercase text-white">Sincronizando</span></div>}
                    </header>
                    <div className="p-4 sm:p-6 pt-12 max-w-7xl mx-auto text-left">
                        {mainTab === 'data' ? <Dashboard equipments={equipments} rooms={rooms} /> : mainTab === 'rooms' ? (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 text-left">
                                {rooms.map(or => (
                                    <div key={or.id} onClick={() => { setSelectedORId(or.id); setView('detail'); }} className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden cursor-pointer hover:shadow-xl transition-all group text-left">
                                        <div className="h-40 sm:h-44 bg-slate-200 relative overflow-hidden"><img src={or.imagen} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /><div className={`absolute top-4 right-4 px-3 py-1 rounded-full text-[10px] font-bold text-white shadow-lg ${getStatusColor(or.estado)}`}>{or.estado?.toUpperCase()}</div></div>
                                        <div className="p-6 flex justify-between items-center text-slate-800 text-left"><div><h3 className="font-bold text-[#00A896] text-xl truncate">{or.nombre}</h3><p className="text-[10px] text-slate-400 font-medium uppercase">{or.especialidad}</p></div><Icon name="ChevronRight" size={18} className="text-slate-300" /></div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 text-left text-slate-800">
                                {EQUIPOS_NOMBRES.map(fam => {
                                    const exis = equipments.filter(e => e.nombre === fam && e.existe !== false);
                                    const img = familyImages[fam];
                                    return (
                                        <div key={fam} onClick={() => { setSelectedFamily(fam); setView('family_detail'); }} className="bg-white rounded-[2rem] sm:rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden hover:shadow-2xl transition-all cursor-pointer group flex flex-col text-left">
                                            <div className="h-32 sm:h-40 relative bg-slate-100 flex items-center justify-center overflow-hidden">{img ? <img src={img} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /> : <Icon name="Layers" size={40} className="text-slate-200" />}<div className="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent opacity-60"></div></div>
                                            <div className="p-6 sm:p-8 pt-4 text-left"><div className="flex justify-between items-start mb-4 text-left"><h2 className="text-xl sm:text-2xl font-black text-[#00A896]">{fam}</h2><Icon name="ChevronRight" size={20} className="text-slate-200 group-hover:text-[#00A896]" /></div>
                                                <div className="flex flex-wrap gap-2 mt-4 text-left">
                                                    <div className="bg-emerald-50 px-3 py-1 rounded-xl border border-emerald-100 flex items-center gap-1.5"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span className="text-[9px] font-bold text-emerald-600">ok: {exis.filter(e => calcularAntiguedad(e.fechaAdquisicion) < 10).length}</span></div>
                                                    <div className="bg-amber-50 px-3 py-1 rounded-xl border border-amber-100 flex items-center gap-1.5"><div className="w-1.5 h-1.5 rounded-full bg-amber-500"></div><span className="text-[9px] font-bold text-amber-600">vet: {exis.filter(e => calcularAntiguedad(e.fechaAdquisicion) >= 10 && calcularAntiguedad(e.fechaAdquisicion) <= 15).length}</span></div>
                                                    <div className="bg-red-50 px-3 py-1 rounded-xl border border-red-100 flex items-center gap-1.5"><div className="w-1.5 h-1.5 rounded-full bg-red-500"></div><span className="text-[9px] font-bold text-red-600">obs: {exis.filter(e => calcularAntiguedad(e.fechaAdquisicion) > 15).length}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );

            if (view === 'family_detail' && selectedFamily) return (
                <div className="min-h-screen bg-slate-50 pb-20 animate-in text-left text-slate-800">
                    <div className="h-64 md:h-80 relative overflow-hidden bg-[#00A896]">
                        {familyImages[selectedFamily] ? <img src={familyImages[selectedFamily]} className="w-full h-full object-cover opacity-80" /> : <div className="w-full h-full flex items-center justify-center text-white/20"><Icon name="Layers" size={80} /></div>}
                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/30"></div>
                        <nav className="absolute top-0 left-0 right-0 p-5 flex justify-between z-10"><button onClick={() => setView('landing')} className="flex items-center gap-2 font-bold text-sm text-white bg-white/10 backdrop-blur-md px-4 py-2 rounded-xl hover:bg-white/20"><Icon name="ChevronLeft" size={20} /> Volver</button><button onClick={() => familyFileRef.current.click()} className="p-2.5 bg-white text-[#00A896] rounded-xl shadow-2xl hover:scale-105"><Icon name="Camera" size={20} /></button><input type="file" ref={familyFileRef} className="hidden" onChange={(e) => handleUpload(e, 'family', selectedFamily)} /></nav>
                        <div className="absolute bottom-8 left-8 text-white pr-8"><h1 className="text-3xl md:text-6xl font-black uppercase tracking-tighter leading-tight">{selectedFamily}</h1><p className="text-white/80 font-medium mt-2 uppercase text-[10px] tracking-widest flex items-center gap-2"><Icon name="Activity" size={14} /> {equipments.filter(e => e.nombre === selectedFamily && e.existe !== false).length} Activos en Hospital</p></div>
                    </div>
                    <div className="p-4 sm:p-6 pt-12 max-w-7xl mx-auto text-left"><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 text-left">
                        {equipments.filter(e => e.nombre === selectedFamily).sort((a,b) => parseInt(a.roomId) - parseInt(b.roomId)).map(eq => {
                            const anios = calcularAntiguedad(eq.fechaAdquisicion), ageC = getAgeColors(anios);
                            return (
                                <div key={eq.id} onClick={() => { setSelectedEqId(eq.id); setView('eq'); }} className={`bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden cursor-pointer hover:shadow-xl transition-all border-l-4 ${!eq.existe ? 'opacity-60 grayscale bg-slate-50 border-l-red-500' : ageC.border} text-left`}>
                                    <div className="h-40 sm:h-44 bg-slate-100 relative"><img src={eq.imagen} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /><div className={`absolute top-4 right-4 px-3 py-1 rounded-full text-[9px] font-bold text-white shadow-lg ${getStatusColor(eq.estado)}`}>{eq.estado?.toUpperCase()}</div></div>
                                    <div className="p-6 text-left"><h3 className="font-black text-[#00A896] text-xl truncate">{rooms.find(r => r.id.toString() === eq.roomId.toString())?.nombre}</h3><p className="text-xs text-slate-400 italic truncate mb-4">"{eq.descripcion}"</p><div className="flex justify-between items-center">{eq.existe ? <span className={`text-[10px] font-bold uppercase ${ageC.text}`}>{anios} años</span> : <span className="text-red-500 font-black text-[9px] uppercase"><Icon name="EyeOff" size={10} /> NO DISPONIBLE</span>}<Icon name="ChevronRight" size={16} className="text-slate-200" /></div></div>
                                </div>
                            );
                        })}
                    </div></div>
                </div>
            );

            if (view === 'detail' && selectedOR) return (
                <div className="min-h-screen bg-white pb-20 animate-in text-left text-slate-800">
                    <div className="h-64 sm:h-80 bg-slate-900 relative overflow-hidden"><img src={selectedOR.imagen} className="w-full h-full object-cover opacity-80" /><div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                        <button onClick={() => setView('landing')} className="absolute top-6 left-6 p-2 bg-white/10 rounded-xl text-white backdrop-blur-md"><Icon name="ChevronLeft" size={20} /></button>
                        <button onClick={() => fileRef.current.click()} className="absolute top-6 right-6 p-2 bg-[#00A896] rounded-xl text-white shadow-lg"><Icon name="Camera" size={20} /></button><input type="file" ref={fileRef} className="hidden" onChange={(e) => handleUpload(e, 'room', selectedOR.id)} />
                        <div className="absolute bottom-8 left-8 text-white pr-8"><h2 className="text-4xl sm:text-5xl font-black uppercase tracking-tighter">{selectedOR.nombre}</h2><div className="flex items-center gap-3 mt-4 text-white/80"><p className="flex items-center gap-2 text-sm sm:text-lg"><Icon name="Stethoscope" size={18} className="text-[#00A896]" /> {selectedOR.especialidad}</p><span className={`px-3 py-1 rounded-full text-[9px] font-bold shadow-lg ${getStatusColor(selectedOR.estado)} text-white`}>{selectedOR.estado}</span></div></div>
                    </div>
                    <div className="px-4 sm:px-6 max-w-5xl mx-auto -mt-8 relative z-10 text-left">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-10 text-left">
                            {['Operativo', 'Mantenimiento', 'No disponible'].map(st => (
                                <button key={st} onClick={() => saveChange('rooms', selectedOR.id.toString(), {estado: st})} className={`p-4 rounded-2xl font-bold text-[10px] sm:text-xs border-2 transition-all ${selectedOR.estado === st ? 'bg-slate-900 text-white shadow-xl' : 'bg-white text-slate-400 border-slate-100 hover:bg-slate-50'}`} style={selectedOR.estado === st ? { borderColor: st === 'Operativo' ? '#10b981' : st === 'Mantenimiento' ? '#f59e0b' : '#ef4444', borderTopWidth: '4px' } : {}}>{st.toUpperCase()}</button>
                            ))}
                        </div>
                        <h3 className="font-bold text-xl mb-6 flex items-center gap-3 text-slate-800"><Icon name="Activity" className="text-[#00A896]" size={24} /> Inventario en Quirófano</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                            {equipments.filter(e => e.roomId == selectedOR.id).map(eq => {
                                const anios = calcularAntiguedad(eq.fechaAdquisicion), ageC = getAgeColors(anios), over = isMaintenanceOverdue(eq.ultimaRevision, eq.periodicidad);
                                return (
                                    <div key={eq.id} onClick={() => { setSelectedEqId(eq.id); setView('eq'); }} className={`flex items-center p-4 bg-white border border-slate-100 rounded-3xl border-l-4 shadow-sm hover:shadow-md cursor-pointer transition-all ${!eq.existe ? 'opacity-60 grayscale border-l-red-500' : ageC.border} text-left`}>
                                        <div className="w-14 h-14 sm:w-16 sm:h-16 bg-slate-100 rounded-2xl overflow-hidden flex-shrink-0 border relative"><img src={eq.imagen} className="w-full h-full object-cover" />{eq.existe && eq.requierePreventivo !== false && <div className={`absolute top-1 right-1 p-0.5 rounded-full shadow-sm ${over ? 'bg-red-500' : 'bg-emerald-500'}`}><Icon name={over ? 'X' : 'Check'} size={8} strokeWidth={4} className="text-white" /></div>}</div>
                                        <div className="ml-4 flex-grow overflow-hidden"><h4 className="font-bold text-slate-800 text-sm sm:text-base truncate">{eq.nombre}</h4><p className="text-[9px] font-bold text-slate-400 tracking-wider uppercase">{eq.existe ? <span className="flex items-center gap-1.5"><span className="truncate italic max-w-[100px] sm:max-w-[140px]">"{eq.descripcion}"</span>•<span className={ageC.text}>{anios} años</span></span> : <span className="text-red-500 flex items-center gap-1 font-black uppercase"><Icon name="EyeOff" size={10} /> NO DISPONIBLE</span>}</p></div>
                                        <Icon name="ChevronRight" size={16} className="text-slate-300" />
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );

            if (view === 'eq' && selectedEq) return (
                <div className="min-h-screen bg-slate-50 pb-10 animate-in text-left text-slate-800">
                    <nav className="bg-[#00A896] p-4 sm:p-5 text-white flex justify-between items-center sticky top-0 z-30"><button onClick={() => { if(selectedFamily && mainTab === 'families') setView('family_detail'); else setView('detail'); }} className="flex items-center gap-2 font-bold hover:text-white/80 transition-all"><Icon name="ChevronLeft" size={20} /> Volver</button><span className="font-extrabold uppercase text-sm sm:text-xl truncate ml-2">{selectedEq.nombre}</span><div className="w-10"></div></nav>
                    <div className="max-w-5xl mx-auto p-4 sm:p-6"><div className="bg-white rounded-[2rem] sm:rounded-[2.5rem] shadow-xl overflow-hidden border border-slate-100">
                        {selectedEq.existe !== false ? (
                            <div>
                                <div className="aspect-video bg-slate-200 relative group"><img src={selectedEq.imagen} className="w-full h-full object-cover" /><button onClick={() => eqFileRef.current.click()} className="absolute bottom-4 right-4 sm:bottom-6 sm:right-6 p-3 sm:p-4 bg-[#00A896] text-white rounded-2xl shadow-2xl hover:scale-110 active:scale-95 transition-all"><Icon name="Camera" size={22} /></button><input type="file" ref={eqFileRef} className="hidden" onChange={(e) => handleUpload(e, 'eq', selectedEq.id)} /><div className="absolute top-4 left-4 sm:top-6 sm:left-6"><span className="bg-[#00A896] text-white text-[9px] font-bold px-3 py-1.5 rounded-full uppercase shadow-xl">{selectedEq.tipo}</span></div></div>
                                <div className="p-6 sm:p-12">
                                    <div className="flex flex-col md:flex-row justify-between items-start gap-4 mb-8 sm:mb-10"><h2 className="text-2xl sm:text-4xl font-black text-slate-900 leading-tight">{selectedEq.nombre}</h2><button onClick={() => { const opts = ['Operativo', 'Mantenimiento', 'No disponible']; saveChange('equipments', selectedEq.id, { estado: opts[(opts.indexOf(selectedEq.estado || 'Operativo') + 1) % 3] }); }} className={`w-full sm:w-auto px-5 py-2.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 uppercase text-[10px] text-white ${getStatusColor(selectedEq.estado)} ${selectedEq.estado === 'Mantenimiento' ? 'animate-pulse' : ''}`}>{selectedEq.estado === 'Operativo' ? <Icon name="Check" size={16}/> : selectedEq.estado === 'No disponible' ? <Icon name="AlertCircle" size={16} /> : <Icon name="RefreshCw" size={16} className="animate-spin text-left"/>} {selectedEq.estado}</button></div>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10 text-left">
                                        <div className="lg:col-span-2">
                                            <div className="flex items-center justify-between mb-4 text-slate-400"><h3 className="text-[9px] font-black uppercase flex items-center gap-2"><Icon name="Info" size={12} className="text-[#00A896]" /> Descripción Técnica</h3><button onClick={() => setIsEditingDesc(!isEditingDesc)} className="hover:text-[#00A896]"><Icon name="Edit" size={14} /></button></div>
                                            {isEditingDesc ? <div className="space-y-4 text-left"><textarea className="w-full p-6 bg-slate-50 border-2 border-[#00A896] rounded-2xl outline-none text-left" value={selectedEq.descripcion} onChange={(e) => saveChange('equipments', selectedEq.id, { descripcion: e.target.value })} /><button onClick={() => setIsEditingDesc(false)} className="bg-[#00A896] text-white px-5 py-2 rounded-xl font-bold text-xs">Guardar Cambios</button></div> : <p className="text-slate-600 text-base sm:text-lg italic bg-slate-50 p-6 rounded-3xl border border-slate-100">"{selectedEq.descripcion}"</p>}
                                        </div>
                                        <div className={`p-6 rounded-[2rem] border-2 flex flex-col items-center justify-center text-center relative ${getAgeColors(calcularAntiguedad(selectedEq.fechaAdquisicion)).fullBorder} ${getAgeColors(calcularAntiguedad(selectedEq.fechaAdquisicion)).bg}`}>
                                            <button onClick={() => setIsEditingAge(!isEditingAge)} className={`absolute top-4 right-4 opacity-50 hover:opacity-100 ${getAgeColors(calcularAntiguedad(selectedEq.fechaAdquisicion)).text}`}><Icon name="Edit" size={14} /></button>
                                            {isEditingAge ? <div className="w-full space-y-2 animate-in"><input type="date" className="w-full p-2 bg-white rounded-lg text-xs font-bold text-center border outline-none" value={selectedEq.fechaAdquisicion} onChange={e => saveChange('equipments', selectedEq.id, { fechaAdquisicion: e.target.value })} /><button onClick={() => setIsEditingAge(false)} className="w-full bg-slate-800 text-white py-1 rounded-lg text-[10px] font-bold">Cerrar</button></div> : <React.Fragment><Icon name="History" className={`${getAgeColors(calcularAntiguedad(selectedEq.fechaAdquisicion)).text} mb-2`} size={24} /><p className={`text-5xl font-black ${getAgeColors(calcularAntiguedad(selectedEq.fechaAdquisicion)).text}`}>{calcularAntiguedad(selectedEq.fechaAdquisicion)}</p><p className={`text-[9px] font-bold uppercase opacity-60 ${getAgeColors(calcularAntiguedad(selectedEq.fechaAdquisicion)).text}`}>Años de Servicio</p></React.Fragment>}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left mb-12">
                                        <div className={`p-6 rounded-3xl border transition-all ${selectedEq.requierePreventivo === false ? 'bg-slate-50 border-slate-100 grayscale opacity-70' : 'bg-white border-slate-100'}`}>
                                            <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-3 text-slate-400"><Icon name="Calendar" size={20} /><span className={`text-[9px] font-bold uppercase ${selectedEq.requierePreventivo === false ? 'text-slate-400' : 'text-[#00A896]'}`}>Mantenimiento</span></div><div className="flex items-center gap-2"><button onClick={() => saveChange('equipments', selectedEq.id, { requierePreventivo: selectedEq.requierePreventivo !== false ? false : true })} className={`w-8 h-4 rounded-full transition-all relative ${selectedEq.requierePreventivo !== false ? 'bg-[#00A896]' : 'bg-slate-300'}`}><div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all`} style={{left: selectedEq.requierePreventivo !== false ? '18px' : '2px'}}></div></button>{selectedEq.requierePreventivo !== false && <button onClick={() => setIsEditingMaint(!isEditingMaint)} className="text-slate-300 hover:text-[#00A896] ml-2"><Icon name="Edit" size={14}/></button>}</div></div>
                                            {selectedEq.requierePreventivo === false ? <div className="flex flex-col items-center justify-center py-4 text-center"><Icon name="EyeOff" size={32} className="text-slate-300 mb-2" /><p className="text-xs font-bold text-slate-400 italic">Sin preventivo programado</p></div> : isEditingMaint ? <div className="space-y-4 animate-in"><input type="date" className="w-full p-2.5 border rounded-xl font-bold text-sm text-slate-800" value={selectedEq.ultimaRevision} onChange={e => saveChange('equipments', selectedEq.id, { ultimaRevision: e.target.value })} /><select className="w-full p-2.5 border rounded-xl font-bold text-sm text-slate-800" value={selectedEq.periodicidad} onChange={e => saveChange('equipments', selectedEq.id, { periodicidad: e.target.value })}><option value="semestral">Semestral</option><option value="anual">Anual</option><option value="bienal">Bienal</option></select><button onClick={() => handleMaintDoneToday(selectedEq.id)} className="w-full bg-blue-500 text-white py-2 rounded-xl text-xs font-black uppercase hover:bg-blue-600 shadow-md">Realizado HOY</button><button onClick={() => setIsEditingMaint(false)} className="w-full bg-[#00A896] text-white py-2 rounded-xl text-xs font-bold uppercase">Cerrar</button></div> : <React.Fragment><div className="flex items-center gap-3"><p className="text-2xl sm:text-3xl font-black">{new Date(selectedEq.ultimaRevision).toLocaleDateString('es-ES')}</p><div className={`p-1 rounded-full ${isMaintenanceOverdue(selectedEq.ultimaRevision, selectedEq.periodicidad) ? 'bg-red-500' : 'bg-emerald-500'}`}><Icon name={isMaintenanceOverdue(selectedEq.ultimaRevision, selectedEq.periodicidad) ? 'X' : 'Check'} size={14} strokeWidth={4} className="text-white" /></div></div><div className="mt-4 pt-4 border-t border-slate-50"><p className="text-[9px] font-bold text-slate-400 uppercase mb-1">Próxima ({selectedEq.periodicidad})</p><p className={`font-bold flex items-center gap-1.5 text-sm ${isMaintenanceOverdue(selectedEq.ultimaRevision, selectedEq.periodicidad) ? 'text-red-500' : 'text-emerald-600'}`}><Icon name={isMaintenanceOverdue(selectedEq.ultimaRevision, selectedEq.periodicidad) ? 'AlertCircle' : 'Check'} size={14} /> {calcularProximaRevision(selectedEq.ultimaRevision, selectedEq.periodicidad)}</p></div></React.Fragment>}
                                        </div>
                                        <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col justify-center text-slate-800 transition-all hover:border-[#00A896]">
                                            <div className="flex items-center gap-3 text-slate-400 mb-4"><Icon name="FileText" size={20} /><span className="text-[9px] font-bold uppercase tracking-widest">Manual Técnico</span></div>
                                            {selectedEq.manualUrl || selectedEq.manualExternalUrl ? <div className="space-y-3 animate-in"><button onClick={() => { if (selectedEq.manualExternalUrl) window.open(selectedEq.manualExternalUrl); else { const win = window.open(); win.document.write(`<iframe src="${selectedEq.manualUrl}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`); } }} className="flex items-center gap-2 text-[#00A896] font-bold text-lg sm:text-xl hover:translate-x-1 transition-all">Ver Documento <Icon name="ExternalLink" size={20} /></button><button onClick={() => saveChange('equipments', selectedEq.id, { manualUrl: "", manualExternalUrl: "" })} className="text-[9px] font-bold text-slate-300 hover:text-red-500 uppercase flex items-center gap-1 transition-colors">Eliminar</button></div> : <div className="flex flex-col gap-3"><button onClick={() => manualFileRef.current.click()} className="flex items-center gap-2 text-slate-400 font-bold text-lg hover:text-[#00A896]"><Icon name="Camera" size={20} /> Subir PDF</button><div className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-dashed border-slate-200"><Icon name="Link" size={16} className="text-slate-400" /><input className="bg-transparent text-xs outline-none w-full font-medium" placeholder="O pega un enlace..." value={manualLink} onChange={(e) => setManualLink(e.target.value)} onBlur={() => { if(manualLink) { saveChange('equipments', selectedEq.id, { manualExternalUrl: manualLink, manualUrl: "" }); setManualLink(''); } }} /></div></div>}
                                            <input type="file" ref={manualFileRef} className="hidden" accept="application/pdf" onChange={(e) => handleUpload(e, 'manual', selectedEq.id)} />
                                        </div>
                                    </div>

                                    <div className="bg-blue-50/50 p-6 sm:p-8 rounded-[2rem] sm:rounded-[2.5rem] border border-blue-100 flex flex-col sm:flex-row items-center justify-between gap-6 mb-12">
                                        <div className="flex items-center gap-4 text-left">
                                            <div className="p-4 bg-white rounded-2xl text-blue-600 shadow-sm shrink-0"><Icon name="Truck" size={28} /></div>
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-base sm:text-lg">Intercambio de Ubicación</h4>
                                                <p className="text-[10px] sm:text-xs text-slate-500 font-medium">Si el destino tiene uno igual, se intercambiarán.</p>
                                            </div>
                                        </div>
                                        {isTransferring ? (
                                            <div className="flex items-center gap-2 animate-in w-full sm:w-auto">
                                                <select className="flex-grow p-3 bg-white border rounded-xl font-bold text-xs sm:text-sm text-slate-800 outline-none shadow-sm min-w-[120px]" onChange={(e) => handleTransfer(selectedEq, e.target.value)}>
                                                    <option value="">Destino...</option>
                                                    {rooms.filter(r => r.id.toString() !== selectedEq.roomId.toString()).map(r => (<option key={r.id} value={r.id}>{r.nombre}</option>))}
                                                </select>
                                                <button onClick={() => setIsTransferring(false)} className="p-3 text-slate-400 hover:text-red-500"><Icon name="X" size={20}/></button>
                                            </div>
                                        ) : <button onClick={() => setIsTransferring(true)} className="w-full sm:w-auto px-8 py-3 bg-blue-600 text-white rounded-2xl font-black text-[10px] sm:text-xs uppercase hover:bg-blue-700 shadow-lg">Gestionar Traslado</button>}
                                    </div>
                                    {transferMsg && <div className="p-4 bg-blue-600 text-white rounded-2xl text-center font-bold text-xs sm:text-sm animate-bounce mb-8">{transferMsg}</div>}

                                    <div className="mt-8 sm:mt-12 pt-8 sm:pt-12 border-t border-slate-100">
                                        <div className="bg-slate-50 p-6 rounded-3xl flex flex-col sm:flex-row items-center justify-between gap-6 shadow-inner">
                                            <div className="flex items-center gap-4">
                                                <div className="p-3 bg-white rounded-2xl text-red-500 shadow-sm shrink-0"><Icon name="AlertCircle" size={24} /></div>
                                                <div className="text-left"><h4 className="font-bold text-sm sm:text-base">Gestión de Inventario</h4><p className="text-[10px] text-slate-400 font-medium leading-relaxed">Marcar equipo como no disponible físicamente en sala.</p></div>
                                            </div>
                                            <button onClick={() => saveChange('equipments', selectedEq.id, { existe: false })} className="w-full sm:w-auto px-6 py-3 bg-red-50 text-red-600 rounded-2xl font-black text-[10px] uppercase border border-red-100 hover:bg-red-500 hover:text-white transition-all">Marcar como Inexistente</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="p-10 sm:p-20 text-center bg-white flex flex-col items-center gap-6 animate-in">
                                <div className="w-20 h-20 sm:w-24 sm:h-24 bg-slate-50 rounded-full flex items-center justify-center text-slate-200 border border-slate-100"><Icon name="EyeOff" size={48} /></div>
                                <h3 className="text-2xl sm:text-3xl font-black text-red-500 uppercase tracking-tighter">No disponible en sala</h3>
                                <button onClick={() => saveChange('equipments', selectedEq.id, { existe: true })} className="bg-[#00A896] text-white px-8 sm:px-10 py-3 sm:py-4 rounded-full font-bold shadow-xl hover:scale-105 transition-all uppercase text-[10px] sm:text-xs tracking-widest">Habilitar en Sala</button>
                            </div>
                        )}
                    </div></div>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <div id="size-alert" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-6 text-left">
        <div class="bg-white p-8 rounded-[2.5rem] max-w-sm w-full text-center shadow-2xl">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-left"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
            <h3 class="text-xl font-black text-slate-800 mb-2">Archivo muy pesado</h3>
            <p class="text-sm text-slate-500 mb-6 leading-relaxed">El PDF supera 1MB. Por favor, súbelo a la nube (Drive/Dropbox) y pega el enlace.</p>
            <button onclick="document.getElementById('size-alert').style.display='none'" class="w-full bg-[#00A896] text-white py-3 rounded-2xl font-bold transition-colors">Entendido</button>
        </div>
    </div>
</body>
</html>
